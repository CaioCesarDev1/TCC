generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Patient {
  id             String                  @id @default(cuid())
  fhirId         String                  @unique
  active         Boolean                 @default(true)
  gender         String?
  birthDate      DateTime?               @db.Date
  maritalStatus  String?
  deceased       Boolean?                @default(false)
  language       String?
  createdAt      DateTime                @default(now())
  updatedAt      DateTime                @updatedAt

  identifiers    Identifier[]
  names          HumanName[]
  telecoms       ContactPoint[]
  addresses      Address[]
  encounters     Encounter[]
  observations   Observation[]
  allergies      AllergyIntolerance[]
  conditions     Condition[]
  procedures     Procedure[]
  medications    MedicationStatement[]
  auditEvents    AuditEvent[]
  credential     PatientCredential?
}

model Identifier {
  id              String   @id @default(cuid())
  use             String?
  system          String?
  value           String
  typeCode        String?
  typeDisplay     String?
  assigner        String?
  resourceType    String
  createdAt       DateTime @default(now())

  patientId       String?
  practitionerId  String?
  organizationId  String?
  encounterId     String?

  patient         Patient?      @relation(fields: [patientId], references: [id])
  practitioner    Practitioner? @relation(fields: [practitionerId], references: [id])
  organization    Organization? @relation(fields: [organizationId], references: [id])
  encounter       Encounter?    @relation(fields: [encounterId], references: [id])

  @@index([resourceType, value])
  @@index([system, value])
}

model HumanName {
  id         String   @id @default(cuid())
  use        String?
  family     String?
  given      String?
  text       String?
  periodStart DateTime? @db.Date
  periodEnd  DateTime? @db.Date
  createdAt  DateTime @default(now())

  patientId  String?
  practitionerId String?

  patient    Patient?      @relation(fields: [patientId], references: [id])
  practitioner Practitioner? @relation(fields: [practitionerId], references: [id])
}

model ContactPoint {
  id            String   @id @default(cuid())
  system        String?
  value         String?
  use           String?
  rank          Int?
  periodStart   DateTime? @db.Date
  periodEnd     DateTime? @db.Date
  createdAt     DateTime @default(now())

  patientId     String?
  practitionerId String?
  organizationId String?

  patient       Patient?      @relation(fields: [patientId], references: [id])
  practitioner  Practitioner? @relation(fields: [practitionerId], references: [id])
  organization  Organization? @relation(fields: [organizationId], references: [id])
}

model Address {
  id            String   @id @default(cuid())
  use           String?
  type          String?
  text          String?
  line1         String?
  line2         String?
  district      String?
  city          String?
  state         String?
  postalCode    String?
  country       String?
  periodStart   DateTime? @db.Date
  periodEnd     DateTime? @db.Date
  createdAt     DateTime @default(now())

  patientId     String?
  organizationId String?

  patient       Patient?      @relation(fields: [patientId], references: [id])
  organization  Organization? @relation(fields: [organizationId], references: [id])
}

model Organization {
  id           String   @id @default(cuid())
  fhirId       String   @unique
  name         String
  typeCode     String?
  typeDisplay  String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  identifiers  Identifier[]
  telecoms     ContactPoint[]
  addresses    Address[]
  encounters   Encounter[]      @relation("OrganizationEncounters")
  providedCare Encounter[]      @relation("ServiceProviderEncounters")
}

model Practitioner {
  id           String   @id @default(cuid())
  fhirId       String   @unique
  active       Boolean  @default(true)
  gender       String?
  birthDate    DateTime? @db.Date
  qualificationCode String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  identifiers  Identifier[]
  names        HumanName[]
  telecoms     ContactPoint[]
  encounters   Encounter[]            @relation("PractitionerEncounters")
  observations Observation[]          @relation("ObservationPerformer")
  allergies    AllergyIntolerance[]   @relation("AllergyRecorder")
  conditions   Condition[]            @relation("ConditionRecorder")
  procedures   Procedure[]            @relation("ProcedurePerformer")
  medications  MedicationStatement[]  @relation("MedicationRecorder")
}

model Encounter {
  id                String    @id @default(cuid())
  fhirId            String    @unique
  status            String
  classCode         String?
  classDisplay      String?
  typeCode          String?
  typeDisplay       String?
  reasonCode        String?
  reasonDisplay     String?
  start             DateTime? @db.Timestamp(6)
  end               DateTime? @db.Timestamp(6)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  patientId         String
  organizationId    String?
  serviceProviderId String?
  practitionerId    String?

  patient           Patient    @relation(fields: [patientId], references: [id])
  organization      Organization? @relation("OrganizationEncounters", fields: [organizationId], references: [id])
  serviceProvider   Organization? @relation("ServiceProviderEncounters", fields: [serviceProviderId], references: [id])
  practitioner      Practitioner? @relation("PractitionerEncounters", fields: [practitionerId], references: [id])

  identifiers       Identifier[]
  observations      Observation[]
  procedures        Procedure[]
}

model Observation {
  id                 String    @id @default(cuid())
  fhirId             String    @unique
  status             String
  categoryCode       String?
  categoryDisplay    String?
  codeSystem         String?
  code               String?
  codeDisplay        String?
  issued             DateTime? @db.Timestamp(6)
  effectiveDateTime  DateTime? @db.Timestamp(6)
  valueQuantity      Decimal?  @db.Decimal(12, 4)
  valueQuantityUnit  String?
  valueString        String?
  valueCodeSystem    String?
  valueCode          String?
  valueCodeDisplay   String?
  interpretationCode String?
  interpretationText String?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  patientId          String
  encounterId        String?
  performerId        String?

  patient            Patient       @relation(fields: [patientId], references: [id])
  encounter          Encounter?    @relation(fields: [encounterId], references: [id])
  performer          Practitioner? @relation("ObservationPerformer", fields: [performerId], references: [id])

  components         ObservationComponent[]
}

model ObservationComponent {
  id                 String   @id @default(cuid())
  codeSystem         String?
  code               String?
  codeDisplay        String?
  valueQuantity      Decimal? @db.Decimal(12, 4)
  valueQuantityUnit  String?
  valueString        String?
  valueCodeSystem    String?
  valueCode          String?
  valueCodeDisplay   String?
  observationId      String

  observation        Observation @relation(fields: [observationId], references: [id])
}

model AllergyIntolerance {
  id                 String   @id @default(cuid())
  fhirId             String   @unique
  clinicalStatusCode String?
  clinicalStatusText String?
  verificationStatus String?
  codeSystem         String?
  code               String?
  codeDisplay        String?
  criticality        String?
  recordedDate       DateTime? @db.Timestamp(6)
  lastOccurrence     DateTime? @db.Timestamp(6)
  note               String?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  patientId          String
  recorderId         String?

  patient            Patient       @relation(fields: [patientId], references: [id])
  recorder           Practitioner? @relation("AllergyRecorder", fields: [recorderId], references: [id])
}

model Condition {
  id                 String   @id @default(cuid())
  fhirId             String   @unique
  clinicalStatus     String?
  verificationStatus String?
  categoryCode       String?
  codeSystem         String?
  code               String?
  codeDisplay        String?
  onsetDateTime      DateTime? @db.Timestamp(6)
  recordedDate       DateTime? @db.Timestamp(6)
  note               String?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  patientId          String
  recorderId         String?

  patient            Patient       @relation(fields: [patientId], references: [id])
  recorder           Practitioner? @relation("ConditionRecorder", fields: [recorderId], references: [id])
}

model Procedure {
  id                 String   @id @default(cuid())
  fhirId             String   @unique
  status             String?
  categoryCode       String?
  codeSystem         String?
  code               String?
  codeDisplay        String?
  performedStart     DateTime? @db.Timestamp(6)
  performedEnd       DateTime? @db.Timestamp(6)
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  patientId          String
  performerId        String?
  encounterId        String?

  patient            Patient       @relation(fields: [patientId], references: [id])
  performer          Practitioner? @relation("ProcedurePerformer", fields: [performerId], references: [id])
  encounter          Encounter?    @relation(fields: [encounterId], references: [id])
}

model MedicationStatement {
  id                 String   @id @default(cuid())
  fhirId             String   @unique
  status             String?
  categoryCode       String?
  medicationCode     String?
  medicationDisplay  String?
  effectiveStart     DateTime? @db.Timestamp(6)
  effectiveEnd       DateTime? @db.Timestamp(6)
  taken              String?
  note               String?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  patientId          String
  recorderId         String?

  patient            Patient       @relation(fields: [patientId], references: [id])
  recorder           Practitioner? @relation("MedicationRecorder", fields: [recorderId], references: [id])
}

model AuditEvent {
  id            String   @id @default(cuid())
  action        String
  outcome       String?
  recordedAt    DateTime @default(now())
  agentUserId   String?
  sourceName    String?
  patientId     String?
  details       Json?

  patient       Patient? @relation(fields: [patientId], references: [id])
}

model PatientCredential {
  id           String   @id @default(cuid())
  patientId    String   @unique
  username     String   @unique
  passwordHash String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  patient      Patient  @relation(fields: [patientId], references: [id])
}


